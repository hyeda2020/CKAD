# 10. Kustomize Basics
- 가령, 개발 환경(dev, stage, prod)에 따라 같은 리소스의 일부 설정을 다르게 구성하려고 할 때,
  각 환경별로 똑같은 리소스 파일들을 만들어 관리하면 비효율적이므로, Kustomize를 통해 디렉토리 구조 기반으로 관리.  
- base : Application 각 리소스들의 공통적인 부분.  
- overlays : 개발 환경 등 여러 케이스에 따라 base에 다르게 적용해야 하는 부분.  
![image](https://github.com/user-attachments/assets/ef167f32-857c-4aa0-b1bf-ff6f99551e74)

- Directory Structure
![1_bccOUPOcGy_1PIiqi2-8gQ](https://github.com/user-attachments/assets/5b277854-e64f-4aee-9377-7f9319c0f03c)


```
# k8s/base/kustomization.yaml
# base kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - overlays/dev
```
```
# k8s/overlays/dev/kustomization.yaml
# overlays kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - config-map.yaml
  ... k8s/overlays/dev/ 하위 디렉토리에 추가되는 리소스명 등록 ...
```
```
# base에 있는 kustomization을 통해 빌드 명령어를 주면  
# 하위 오버레이에 있는 kustomization들에 재귀적으로 적용.  
kustomize build k8s/ | kubectl apply -f -
```

- Transformers : 리소스 yaml 파일들의 내용 중 일부를 변경하거나 추가하는 기능  
  - commonLabel : 모든 kubernetes 리소스에 label 추가  
  - namePrefix/Suffix : 모든 리소스 name에 접두사/접미사 추가  
  - Namespace : 모든 리소스에 공통적인 네임스페이스 추가  
  - commonAnnotations : 모든 리소스에 애노테이션 추가

```
# Kustomization.yaml
commonLabels:
  org: KodeKloud
namespace : lab
namePrefix: KodeKloud-
nameSuffix: -dev
commonAnnotations:
  branch: master
```
```
# db-service.yaml
apiVersion: v1
kind: Service
metadata:
  annotations: # 애노테이션 추가
    branch: master
  labels: # 레이블 추가
    org: KodeKloud
  name: KodeKloud-api-service-dev # 접두사/접미사 추가
  namespace : lab # 네임스페이스 추가
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPoprt: 3000
  selector:
    component: api
  type: LoadBalancer
```

- Image Transformer : 해당 이미지를 사용하는 모든 컨테이너에 대해 이미지/태그 변경
```
# Kustomization.yaml
images:
  - name : nginx
    newName: haproxy
```
```
# web-depl.yaml
apiVersion: app/v1
kind: Deployment
metadata:
  name: web-deployment
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: web
        # image: nginx (기존 이미지명)
        image: haproxy # 새로운 이미지명
```
