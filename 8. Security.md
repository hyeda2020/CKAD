# 8. Security
- KubeConfig : `kubectl` 명령어로 api 서버에 접근할 때 사용할 인증 정보를 담고 있는 쿠버네티스의 설정 파일.  

![image](https://github.com/user-attachments/assets/8b247acd-4b81-4ea3-9d0d-bc3fddff0e9d)  

- kubeconfig의 구성 요소.  
1) clusters : 접근이 필요한 여러 클러스터들.  
2) users : 각 클러스터에 접근 권한이 있는 사용자 계정.  
3) context : 클러스터에 접근할 때 어떤 사용자 계정이 사용될 수 있는지 지정.(cluster와 user를 서로 매핑).  
    
``` yml
apiVersion: v1
kind: Config

current-context: admin@playground

clusters:
- name: playground
  cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt # 인증서 파일 경로
    certificate-authority-data: # 또는 다음과 같이 인증서 자체의 값을 base64 인코딩하여 저장 가능
        LS0t...Pbnj
    server: https://playgroud:6443
  
contexts:
- name: admin@playground
  context:
    cluster: playground
    user: admin
    namespace: mykube
  
users:
- name: admin
  user: 
    client-certificate: /etc/kubernetes/pki/users/admin.crt
    client-key: /etc/kubernetes/pki/users/admin.key
```  
```
# 만약 admin@playground 외에 prod-user@production 라는 context도 있을 경우 
# kubectl로 context 변경 방법
kubectl config use-context prod-user@production
```

- Role Based Access Controls
![image](https://github.com/user-attachments/assets/8e623d55-58ae-4c4c-9f20-196c0f68ecb8)
  - Role : 특정 리소스 그룹에 대한 접근 권한 지정  
  ``` yml
  # developer-role.yml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
      namespace: default
      name: developer # developer 라는 role 그룹에 대하여
  rules:
  - apiGroups: [""] # "" indicates the core API group
    resources: ["pods"]  # 파드들에 대한
    verbs: ["get", "watch", "list"]  # get, watch, list 조회 부여
  ```  
  - RoleBinding : 특정 Role 권한을 특정 사용자에 부여  
  ``` yml
  # developer-rolebinding.yml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: read-pods
    namespace: default
  subjects:
  - kind: User
    name: dev-user
    apiGroup: rbac.authorization.k8s.io
  roleRef: # User(dev-user)와 Role(developer)을 서로 바인딩
    kind: Role
    name: developer 
    apiGroup: rbac.authorization.k8s.io
  ```
  
  - Cluster Role : Role과 RoleBinding은 특정 네임스페이스 안의 리소스에 대해서만 접근 권한 부여 가능하며,  
    Cluster 단위 리소스들인 Node, Secret, PV, PVC 등에 대해서는 접근 권한 부여가 불가능.  
    따라서, 이러한 Cluster 단위 리소스들에 대한 접근권한은 ClusterRole, ClusterRole Binding을 통해 부여.  
  ``` yml
  # scret-reader-role.yml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: secret-reader
  rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "watch", "list"]
  ```
  ``` yml
  # scret-reader-rolebinding.yml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: read-secrets
    namespace: development
  subjects:
  - kind: User
    name: dev-user
    apiGroup: rbac.authorization.k8s.io
  roleRef:
    kind: ClusterRole
    name: secret-reader
    apiGroup: rbac.authorization.k8s.io
  ```
